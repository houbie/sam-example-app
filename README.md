# sam-example-app

A serverless application with Python lambda's that you can deploy with the [SAM CLI](https://docs.aws.amazon.com/serverless-application-model/index.html).

## Required tools

* Python: preferred installation via [pyenv](https://github.com/pyenv/pyenv#installation)
* Docker - [Install Docker community edition](https://hub.docker.com/search/?type=edition&offering=community)

## Prepare project

We use [poetry](https://python-poetry.org/) for dependency management an
[aws-sam-cli](https://github.com/aws/aws-sam-cli) for build and deploy.

See the section about _Managing your Python setup_

If you don't want to install these tools on your dev machine, you can install them in a virtual environment
via pip (and just delete the virtual environment when you don't need them anymore).

## Build and deploy the application
* activate your virtual environment (automatically done when using pyenv)

* Build preparation:
```bash
cd sam-example-app
#install all (dev) dependencies
poetry install
# export the non-dev dependency list for SAM
poetry export -f requirements.txt --output src/requirements.txt
# assemble the SAM template from the jinja templates in the sam folder
j2 sam/template.yaml > template.yaml
```
* Build with SAM CLI
```bash
sam build
```
* or do all at once with `bin\build.sh`

* Deploy to AWS (outputs the urls of the deployed API gateways are)
    * create an S3 bucket where SAM can upload the deployment files
    * `sam deploy --s3-bucket my-deployment-bucket`
    * add the *--profile* and/or *--region* options when deploying to another region or using another credentials profile

## Use the SAM CLI to build and test locally

The SAM CLI installs dependencies defined in `src/requirements.txt`, creates a deployment package, and saves it
in the `.aws-sam/build` folder.

Test a single function by invoking it directly with a test event (in the `events` folder).

Run functions locally and invoke them with the `sam local invoke` command.

* `sam local invoke EventConsumerFn --event events/api_gw_event.json`
* `sam local invoke S3EventHandlerFn --event events/s3_event.json` (this will fail because the lambda tries to fetch a nonexistent S3 object)


The SAM CLI can also emulate your application's API. Use the `sam local start-api` to run the API locally on port 3000.

`NOTE` Only _AWS::Serverless::Api_ and _AWS::Serverless::HttpApi_ can be tested locally.
You won't be able to test your custom _AWS::ApiGateway::RestApi_ locally.
```bash
sam local start-api
# in other shell
curl  "http://localhost:3000/echo/foo/bar?q=my-query"
curl -X POST -H "Content-Type: application/json" -d '{"foo":"bar"}' http://localhost:3000/consumer-events
curl -X POST -H "Content-Type: application/json" -d '{"foo":"bar"}' http://localhost:3000/events-async
```

## Fetch, tail, and filter Lambda function logs

To simplify troubleshooting, SAM CLI has a command called `sam logs`. `sam logs` lets you fetch logs generated by your
deployed Lambda function from the command line. In addition to printing the logs on the terminal, this command has
several nifty features to help you quickly find the bug.

`NOTE` This command works for all AWS Lambda functions; not just the ones you deploy using SAM.

```bash
sam logs -n EventConsumerFn --stack-name sam-example-app --tail
```

You can find more information and examples about filtering Lambda function logs in
the [SAM CLI Documentation](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-logging.html).

## Unit tests

Tests are defined in the `test` folder in this project.
Use [pytest](https://docs.pytest.org/en/latest/) to run unit tests.
Just run `pytest` in your virtualenv or run tests in your IDE (you have to configure the project to use pytest in Intellij/Pycharm)

The tests require _DynamoDBLocal_, so you need to download it first with `bin/download-dynamo-local.sh`

## Performance/load tests
_test/locust_perf_test.py_ contains a simple load test that posts a small and a large payload both API gateways.
This is to compare two possible architectures for async API gateway event handling.
Example run: `locust -f test/locust_load_tst.py -u 5 -r 5 --headless -t 30s --host=http://localhost:5000 LargePayload`
See [Architecture](#architecture)

`NOTE` The locust tests will use the AWS-CLI to fetch the API Gateway urls.
    Set the *AWS_PROFILE* and/or *AWS_REGION* environment variables when deploying to another region or using another credentials profile.

## Cleanup

To delete the sample application that you created, use the AWS CLI.
The S3 bucket created by the stack needs to be emptied before stack deletion.

```bash
aws s3 rm s3://${USER}-sam-events --recursive
aws cloudformation delete-stack --stack-name sam-example-app
```

`NOTE` add the *--profile* and/or *--region* options when deploying to another region or using another credentials profile

## Intellij / Pycharm

With the _AWS Toolkit_ plugin, you can view/update lambda's, S3 files, cloudwatch logs...

## Managing your Python setup
Note: still have to try out [PDM](https://pdm.fming.dev/), which works like npm. Maybe better then what's described below.

There are lots of ways to install Python and the required tools.
I had the best experience by installing _pyenv_ and _Poetry_ directly on my dev machine:
* Install _pyenv_ via the [installer](https://github.com/pyenv/pyenv-installer) (or the [Windows version](https://github.com/pyenv-win/pyenv-win))
* Install [Poetry](https://python-poetry.org/docs/#installation)

Install the Python version that you want to use for your lambdas (the version for this project is in _.python_version_, currently 3.8.6):
```shell
pyenv install $(head -n 1 .python-version)
```

The _.python_version_ file also makes sure that you use the correct Python version when in this directory.
So we can install the SAM CLI for all projects using this Python version:
```bash
cd sam-example-app # or pyenv shell 3.8.6
pip install aws-sam-cli
```

You can verify with `sam --version`.

`which sam` will show something like _/Users/ihoubr/.pyenv/shims/sam_. You can use this to configure the
_SAM CLI Executable_ in the AWS toolkit (Pycharm, Intellij, Visual Studio)

## Architecture
![Async API gateway event handling](docs/SAM_example_app.png?raw=true "Async API gateway event handling")

What are we trying out here?
* Async handling of API gateway requests (respond with 202 Accepted and handle request in backgrounc)
    * One lambda invoking another asynchronously
    * Redirect the API gateway event to an S3 bucket with a lambda listening to S3 events
        * This makes generic error handling possible 

## Troubleshooting
### AttributeError: 'NoneType' object has no attribute 'get'
This can have multiple causes:
* the virtual environment is not active
* the generated _template.yaml_ is not valid: check that the yaml indentation is OK

### sam build fails
* There can be dependency conflicts between _aws-sam-cli_ and the project dependencies.
  You can solve them by either:
    * run the build in a container `sam build --use-container` (requires docker and is slower)
    * use 2 different virtual environments
      * one in which you only install _aws-sam-cli_ (and other tools)
      * one for the project (without the tools)
      * use pyenv local to activate them both `pyenv local sam-example-app tools-venv`
