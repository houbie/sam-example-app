# sam-example-app

A serverless application with Python lambda's that you can deploy with the [SAM CLI](https://docs.aws.amazon.com/serverless-application-model/index.html).

## Required tools

* Python: preferred installation via [pyenv](https://github.com/pyenv/pyenv#installation)
* Docker - [Install Docker community edition](https://hub.docker.com/search/?type=edition&offering=community)

## Prepare project

We use [poetry](https://python-poetry.org/) for dependency management an
[aws-sam-cli](https://github.com/aws/aws-sam-cli) for build and deploy.

See the section about _Managing your Python setup_

If you don't want to install these tools on your dev machine, you can install them in a virtual environment
via pip (and just delete the virtual environment when you don't need them anymore).

Next install all dependencies:
```bash
cd sam-example-app
poetry install
poetry export -f requirements.txt --output src/requirements.txt # export the dependency list for sam
```

Each time dependencies are added or removed via poetry, we need to sync _src/requirements.txt_.

Dev dependencies and are skipped in _src/requirements.txt_.

## Build and deploy the application

* generate the template: `j2 sam/template.yaml > template.yaml`
* `sam build --use-container`
* `sam deploy`

The API Gateway Endpoint URL's are displayed as the output values after deployment.

## Use the SAM CLI to build and test locally

The SAM CLI installs dependencies defined in `src/requirements.txt`, creates a deployment package, and saves it
in the `.aws-sam/build` folder.

Test a single function by invoking it directly with a test event (in the `events` folder).

Run functions locally and invoke them with the `sam local invoke` command.

* `sam local invoke EventConsumerFn --event events/api_gw_event.json`
* `sam local invoke S3EventHandlerFn --event events/s3_event.json` (this will fail because the lambda tries to fetch a nonexistent S3 object)


The SAM CLI can also emulate your application's API. Use the `sam local start-api` to run the API locally on port 3000.
Note that only the first API gateway in the template will be available.

```bash
sam local start-api
# in other shell
curl -X POST -H "Content-Type: application/json" -d '{"foo":"bar"}' http://localhost:3000/consumer-events
curl -X POST -H "Content-Type: application/json" -d '{"foo":"bar"}' http://localhost:3000/events-async
```

## Fetch, tail, and filter Lambda function logs

To simplify troubleshooting, SAM CLI has a command called `sam logs`. `sam logs` lets you fetch logs generated by your
deployed Lambda function from the command line. In addition to printing the logs on the terminal, this command has
several nifty features to help you quickly find the bug.

`NOTE`: This command works for all AWS Lambda functions; not just the ones you deploy using SAM.

```bash
sam logs -n EventConsumerFn --stack-name sam-example-app --tail
```

You can find more information and examples about filtering Lambda function logs in
the [SAM CLI Documentation](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-logging.html)
.

## Unit tests

Tests are defined in the `test` folder in this project.
Use [pytest](https://docs.pytest.org/en/latest/) to run unit tests.
Just run `pytest` in your virtualenv or run tests in your IDE (you have to configure the project to use pytest in Intellij/Pycharm)

## Cleanup

To delete the sample application that you created, use the AWS CLI.
The S3 bucket created by the stack needs to be emptied before stack deletion.

```bash
aws s3 rm s3://${USER}-sam-events --recursive
aws cloudformation delete-stack --stack-name sam-example-app
```

## Intellij / Pycharm

With the _AWS Toolkit_ plugin, you can view/update lambda's, S3 files, cloudwatch logs...

## Managing your Python setup
There are lots of ways to install Python and the required tools.
I had the best experience by installing _pyenv_ and _Poetry_ directly on my dev machine:
* Install _pyenv_ via the [installer](https://github.com/pyenv/pyenv-installer) (or the [Windows version](https://github.com/pyenv-win/pyenv-win))
* Install [Poetry](https://python-poetry.org/docs/#installation)

Install the Python version that you want to use for your lambdas (the version for this project is in _.python_version_, currently 3.8.6):
```shell
pyenv install $(head -n 1 .python-version)
```

The _.python_version_ file also makes sure that you use the correct Python version when in this directory.
So we can install the SAM CLI for all projects using this Python version:
```bash
cd sam-example-app # or pyenv shell 3.8.6
pip install aws-sam-cli
```

You can verify with `sam --version`.

`which sam` will show something like _/Users/ihoubr/.pyenv/shims/sam_. You can use this to configure the
_SAM CLI Executable_ in the AWS toolkit (Pycharm, Intellij, Visual Studio)
